{% extends "base.html" %}

{% block title %}Elections - {{ chama.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1"><i class="fas fa-vote-yea"></i> {{ chama.name }} Elections</h3>
                            <p class="mb-0 text-white-75">Democratic leadership selection</p>
                        </div>
                        {% if user_role in ['creator', 'chairperson'] %}
                            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#createElectionModal">
                                <i class="fas fa-plus"></i> Create Election
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Current Leadership -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-crown"></i> Current Leadership</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0">
                            <div>
                                <strong>Creator/Founder</strong>
                                {% if leadership.creator %}
                                    <div class="text-muted">{{ leadership.creator.username }}</div>
                                {% else %}
                                    <div class="text-muted">Not assigned</div>
                                {% endif %}
                            </div>
                            <span class="badge bg-success">Permanent</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0">
                            <div>
                                <strong>Chairperson</strong>
                                {% if leadership.chairperson %}
                                    <div class="text-muted">{{ leadership.chairperson.username }}</div>
                                {% else %}
                                    <div class="text-muted">Vacant</div>
                                {% endif %}
                            </div>
                            <span class="badge bg-primary">Elected</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0">
                            <div>
                                <strong>Secretary</strong>
                                {% if leadership.secretary %}
                                    <div class="text-muted">{{ leadership.secretary.username }}</div>
                                {% else %}
                                    <div class="text-muted">Vacant</div>
                                {% endif %}
                            </div>
                            <span class="badge bg-info">Elected</span>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0">
                            <div>
                                <strong>Treasurer</strong>
                                {% if leadership.treasurer %}
                                    <div class="text-muted">{{ leadership.treasurer.username }}</div>
                                {% else %}
                                    <div class="text-muted">Vacant</div>
                                {% endif %}
                            </div>
                            <span class="badge bg-warning text-dark">Elected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Permissions -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-key"></i> Leadership Roles & Access</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="rolesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chairpersonRole">
                                    <strong>Chairperson</strong>
                                </button>
                            </h2>
                            <div id="chairpersonRole" class="accordion-collapse collapse" data-bs-parent="#rolesAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success"></i> Meeting management</li>
                                        <li><i class="fas fa-check text-success"></i> Create elections</li>
                                        <li><i class="fas fa-check text-success"></i> Manage members</li>
                                        <li><i class="fas fa-check text-success"></i> Administrative actions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#secretaryRole">
                                    <strong>Secretary</strong>
                                </button>
                            </h2>
                            <div id="secretaryRole" class="accordion-collapse collapse" data-bs-parent="#rolesAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success"></i> Meeting minutes</li>
                                        <li><i class="fas fa-check text-success"></i> Member communication</li>
                                        <li><i class="fas fa-check text-success"></i> Record keeping</li>
                                        <li><i class="fas fa-check text-success"></i> Generate reports</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#treasurerRole">
                                    <strong>Treasurer</strong>
                                </button>
                            </h2>
                            <div id="treasurerRole" class="accordion-collapse collapse" data-bs-parent="#rolesAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success"></i> Financial oversight</li>
                                        <li><i class="fas fa-check text-success"></i> Approve transactions</li>
                                        <li><i class="fas fa-check text-success"></i> View all finances</li>
                                        <li><i class="fas fa-check text-success"></i> Generate reports</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Elections List -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-ballot-check"></i> Election History</h5>
                </div>
                <div class="card-body p-0">
                    {% if elections %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Position</th>
                                        <th>Status</th>
                                        <th>Phase</th>
                                        <th>Voting Period</th>
                                        <th>Winner</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for election in elections %}
                                    <tr>
                                        <td>
                                            <div class="fw-medium">{{ election.position.title() }}</div>
                                            <small class="text-muted">{{ election.title }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if election.status == 'completed' %}success{% elif election.status == 'voting' %}primary{% elif election.status == 'nominations' %}warning{% else %}secondary{% endif %}">
                                                {{ election.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if election.current_phase == 'voting' %}danger{% elif election.current_phase == 'nominations' %}info{% elif election.current_phase == 'completed' %}success{% else %}secondary{% endif %}">
                                                {{ election.current_phase.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                {{ election.voting_start.strftime('%b %d') }} - {{ election.voting_end.strftime('%b %d, %Y') }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if election.winner %}
                                                <div class="fw-medium text-success">{{ election.winner.username }}</div>
                                                <small class="text-muted">{{ election.total_votes }} votes</small>
                                            {% else %}
                                                <span class="text-muted">TBD</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('elections.election_detail', election_id=election.id) }}" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                {% if election.current_phase == 'completed' and not election.winner and user_role in ['creator', 'chairperson'] %}
                                                    <button class="btn btn-outline-success" onclick="finalizeElection({{ election.id }})">
                                                        <i class="fas fa-trophy"></i> Finalize
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-vote-yea fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Elections Yet</h5>
                            <p class="text-muted mb-0">Start by creating your first leadership election</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Election Modal -->
{% if user_role in ['creator', 'chairperson'] %}
<div class="modal fade" id="createElectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Leadership Election</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createElectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="position" class="form-label">Position <span class="text-danger">*</span></label>
                                <select class="form-select" id="position" name="position" required>
                                    <option value="">Select Position</option>
                                    <option value="chairperson">Chairperson</option>
                                    <option value="secretary">Secretary</option>
                                    <option value="treasurer">Treasurer</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Election Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required
                                       placeholder="e.g., 2024 Chairperson Election">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Describe the purpose and process of this election"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nomination_days" class="form-label">Nomination Period (Days) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="nomination_days" name="nomination_days" 
                                       value="3" min="1" max="14" required>
                                <small class="form-text text-muted">How many days to allow for nominations</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="voting_days" class="form-label">Voting Period (Days) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="voting_days" name="voting_days" 
                                       value="3" min="1" max="14" required>
                                <small class="form-text text-muted">How many days to allow for voting</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createElection()">Create Election</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
{% if user_role in ['creator', 'chairperson'] %}
function createElection() {
    const form = document.getElementById('createElectionForm');
    const formData = new FormData(form);
    
    const data = {
        position: formData.get('position'),
        title: formData.get('title'),
        description: formData.get('description'),
        nomination_days: parseInt(formData.get('nomination_days')),
        voting_days: parseInt(formData.get('voting_days'))
    };
    
    if (!data.position || !data.title) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    fetch(`{{ url_for('elections.create_election', chama_id=chama.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('createElectionModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error creating election', 'error');
        console.error('Error:', error);
    });
}

function finalizeElection(electionId) {
    if (confirm('Finalize this election and assign the winner to the leadership position?')) {
        fetch(`/elections/${electionId}/finalize`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error finalizing election', 'error');
            console.error('Error:', error);
        });
    }
}
{% endif %}
</script>
{% endblock %}
