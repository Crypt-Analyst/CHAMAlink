{% extends "base.html" %}

{% block title %}Help & Support - ChamaLink{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        LeeBot - ChamaLink Assistant
                    </h5>
                    <div class="d-flex align-items-center">
                        <span id="status-indicator" class="badge bg-success me-2">
                            <i class="fas fa-circle"></i> Online
                        </span>
                        <button id="minimize-chat" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="chat-container" class="card-body" style="height: 500px; overflow-y: auto; background: #f8f9fa;">
                    <div id="chat-messages">
                        <!-- Welcome message -->
                        <div class="message-wrapper mb-3">
                            <div class="message bot-message">
                                <div class="message-content bg-white border rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; flex-shrink: 0;">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div>
                                            <strong>LeeBot</strong>
                                            <div class="text-muted small">Just now</div>
                                            <div class="mt-2">
                                                👋 Hello! I'm LeeBot, your intelligent ChamaLink assistant.
                                                <br><br>
                                                I understand your questions and can help you with:
                                                <ul class="mb-2 mt-2">
                                                    <li>🏦 Setting up and managing your chama</li>
                                                    <li>💰 Understanding our pricing and features</li>
                                                    <li>📱 Using M-Pesa and payment integration</li>
                                                    <li>👥 Managing members and contributions</li>
                                                    <li>📊 Generating reports and analytics</li>
                                                    <li>🔧 Troubleshooting technical issues</li>
                                                </ul>
                                                Just ask me anything in natural language, and I'll provide detailed, helpful answers!
                                                <br><br>
                                                <strong>💡 Try asking:</strong> "How do I create a chama?" or "What's the difference between your plans?"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white border-top">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
                        <button id="send-button" class="btn btn-primary" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to send. Type "agent help" to speak with a human agent.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Quick Help Topics</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="chama_creation">
                            🏦 Create Chama
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="subscription_plans">
                            💰 Compare Plans
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="mpesa_integration">
                            📱 M-Pesa Setup
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="member_management">
                            👥 Manage Members
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="reports_analytics">
                            📊 Reports & Analytics
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="agent_help">
                            🤝 Speak with Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-wrapper {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white;
    border: none !important;
}

.bot-message .avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px;
    color: #666;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.quick-topic:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#chat-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
// LeeBot - Intelligent ChamaLink Assistant
class LeeBot {
    constructor() {
        this.context = {
            lastTopic: null,
            conversationHistory: [],
            userIntent: null
        };
        
        // Knowledge base for intelligent responses
        this.knowledgeBase = {
            // Conversational responses
            'greeting': {
                keywords: ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'howdy', 'greetings'],
                response: `👋 **Hello there!** 

I'm LeeBot, your friendly ChamaLink assistant! I'm here to help you with everything related to managing your chama.

I can assist you with:
🏦 Creating and setting up your chama
💰 Understanding our subscription plans and pricing
📱 M-Pesa integration and payment setup
👥 Managing members and invitations
📊 Generating reports and analytics
💬 Answering questions about features

**What would you like to know more about?** Just ask me in your own words - I understand natural language!

*For example, try: "How do I start a chama?" or "What's the best plan for my group?"*`,
                followUp: ['chama creation', 'subscription plans', 'member management']
            },
            
            'how_are_you': {
                keywords: ['how are you', 'how do you do', 'how\'s it going', 'what\'s up', 'how have you been'],
                response: `😊 **I'm doing great, thank you for asking!**

I'm feeling energetic and ready to help you succeed with your chama! 

As an AI assistant, I'm always:
✅ Available 24/7 to help you
🧠 Learning from every conversation
💪 Getting better at understanding your needs
🚀 Excited to help your chama grow and thrive

**How are YOU doing?** More importantly, how can I help you with your chama management needs today?

Feel free to ask me anything about:
• Setting up your first chama
• Managing members and contributions
• Understanding our features and pricing
• Troubleshooting any issues`,
                followUp: ['chama setup help', 'feature overview', 'troubleshooting']
            },
            
            'who_are_you': {
                keywords: ['who are you', 'what are you', 'tell me about yourself', 'introduce yourself'],
                response: `🤖 **I'm LeeBot - Your Intelligent ChamaLink Assistant!**

**About Me:**
• I'm an AI-powered chatbot created specifically for ChamaLink users
• Named after our founder's commitment to innovation and user support
• Designed to make chama management as easy as possible for you

**What I Can Do:**
🎯 **Instant Help**: Get immediate answers to your questions
🧠 **Smart Understanding**: I comprehend natural language, so talk to me normally!
📚 **Deep Knowledge**: I know everything about ChamaLink's features
🔄 **Always Learning**: I improve with every conversation
🚀 **Problem Solving**: Help you overcome any challenges

**My Mission:**
To make digital chama management accessible and effortless for everyone, from tech-savvy users to those just starting their digital journey.

**What would you like to explore together?**`,
                followUp: ['getting started', 'feature tour', 'pricing information']
            },
            
            'thank_you': {
                keywords: ['thank you', 'thanks', 'appreciate', 'grateful', 'cheers'],
                response: `🙏 **You're very welcome!**

I'm so happy I could help you! That's exactly what I'm here for - making your ChamaLink experience smooth and successful.

**Remember:**
• I'm always here when you need assistance
• No question is too basic or too complex
• Feel free to come back anytime you need guidance
• Your success is my success!

**Keep growing your chama!** 🚀

Is there anything else I can help you with today? I'm just a message away whenever you need support with your chama management journey.`,
                followUp: ['more questions', 'feature exploration', 'success tips']
            },
            
            // Chama Management
            'chama_creation': {
                keywords: ['create chama', 'start chama', 'new chama', 'setup chama', 'register chama', 'how to create'],
                response: `🏦 **Creating a Chama on ChamaLink**

To create your chama:

**Step 1: Sign Up**
• Visit ChamaLink.co.ke and click "Get Started"
• Choose your subscription plan (we recommend starting with the free trial)
• Complete your account registration

**Step 2: Set Up Your Chama**
• Go to your dashboard and click "Create New Chama"
• Enter your chama details:
  - Chama name
  - Meeting schedule
  - Contribution amounts and frequency
  - Rules and objectives

**Step 3: Add Members**
• Invite members via email or phone
• Set member roles (admin, treasurer, secretary, member)
• Members will receive invitations to join

**Step 4: Configure Payments**
• Set up your M-Pesa integration
• Define contribution schedules
• Enable automatic tracking

Would you like me to guide you through any specific step?`,
                followUp: ['member management', 'mpesa setup', 'subscription plans']
            },

            'member_management': {
                keywords: ['add members', 'invite members', 'member roles', 'remove member', 'manage members'],
                response: `👥 **Managing Chama Members**

**Adding Members:**
• Navigate to "Members" in your chama dashboard
• Click "Add Member" or "Invite Member"
• Enter their details: name, email, phone number
• Assign roles: Admin, Treasurer, Secretary, or Member
• Send invitation (they'll get email/SMS)

**Member Roles & Permissions:**
• **Admin**: Full access, can modify chama settings
• **Treasurer**: Manages finances, approves transactions
• **Secretary**: Records meetings, sends notifications
• **Member**: Views information, makes contributions

**Managing Existing Members:**
• Edit member details anytime
• Change roles as needed
• Suspend or remove inactive members
• Track individual contribution history

**Pro Tip:** Start with 2-3 trusted friends, then gradually expand your chama!

Need help with specific member management tasks?`,
                followUp: ['roles and permissions', 'contribution tracking', 'member communication']
            },

            'subscription_plans': {
                keywords: ['plans', 'pricing', 'cost', 'subscription', 'how much', 'price', 'basic', 'classic', 'advanced'],
                response: `💰 **ChamaLink Subscription Plans**

**🎯 Basic Plan - KES 200/month**
• Perfect for small chamas (up to 20 members)
• Basic contribution tracking
• M-Pesa integration
• Monthly reports
• Email support

**🚀 Classic Plan - KES 250/month** ⭐ *Most Popular*
• Enhanced features for growing chamas
• Advanced reporting & analytics
• Meeting management
• Priority support
• Data export features

**💎 Advanced Plan - KES 500/month**
• Unlimited chamas and members
• Premium analytics dashboard
• Loan management system
• API access for integrations
• 24/7 priority support

**🎁 Special Offers:**
• 30-day FREE trial on all plans
• 5% discount on 3-month subscriptions
• Get 1 FREE month with 6-month plans
• Get 2 FREE months with 12-month plans

Which plan interests you most?`,
                followUp: ['free trial', 'plan comparison', 'payment methods']
            },

            'mpesa_integration': {
                keywords: ['mpesa', 'm-pesa', 'payment', 'mobile money', 'safaricom', 'pay', 'paybill'],
                response: `📱 **M-Pesa Integration with ChamaLink**

**How it Works:**
• Your chama gets a dedicated M-Pesa paybill or till number
• Members send contributions directly via M-Pesa
• Payments are automatically recorded in your system
• Real-time notifications for all transactions
• Zero manual data entry required!

**Setting Up M-Pesa:**
1. Go to "Payment Settings" in your chama dashboard
2. Choose "M-Pesa Integration"
3. Provide your business details
4. We'll help you get a paybill/till number
5. Configure automatic reconciliation

**Benefits:**
✅ Instant payment confirmation
✅ Automatic record keeping
✅ Reduced errors and disputes
✅ Member convenience
✅ Real-time balance updates

**Requirements:**
• Valid business registration (we can help with this)
• Authorized signatory details
• Bank account for settlements

Want me to guide you through the setup process?`,
                followUp: ['business registration', 'paybill setup', 'payment tracking']
            },

            'reports_analytics': {
                keywords: ['reports', 'analytics', 'statements', 'export', 'data', 'financial report', 'analysis'],
                response: `📊 **Reports & Analytics**

**Available Reports:**
• **Member Contributions**: Individual payment history
• **Financial Statements**: Income, expenses, balances
• **Meeting Minutes**: Automated meeting records
• **Loan Reports**: Outstanding loans and repayments
• **Growth Analytics**: Membership and financial trends
• **Tax Reports**: For compliance and documentation

**Export Options:**
• PDF for sharing and printing
• Excel for further analysis
• CSV for data processing
• Email delivery to stakeholders

**Real-Time Dashboards:**
• Live contribution tracking
• Member activity overview
• Financial health indicators
• Goal progress monitoring

**Automated Insights:**
• Identify late payers
• Track contribution trends
• Forecast future growth
• Risk assessment alerts

**Pro Feature (Classic & Advanced):**
• Custom report builder
• Scheduled report delivery
• Advanced analytics with charts
• Comparative analysis tools

Which type of report are you most interested in?`,
                followUp: ['financial statements', 'member reports', 'export options']
            },

            'loan_management': {
                keywords: ['loan', 'lending', 'borrow', 'credit', 'advance', 'loan application'],
                response: `💳 **Loan Management System**

**For Members (Borrowers):**
• Apply for loans directly through the platform
• View loan eligibility based on contributions
• Track application status in real-time
• Set up automatic repayment schedules
• Access loan history and statements

**For Chama Administrators:**
• Review and approve loan applications
• Set loan policies and interest rates
• Monitor repayment schedules
• Generate loan portfolio reports
• Manage defaulters and collections

**Loan Features:**
• **Eligibility Calculator**: Based on contribution history
• **Interest Management**: Flexible rate setting
• **Repayment Tracking**: Automatic deductions
• **Guarantor System**: Member-backed loans
• **Risk Assessment**: Built-in credit scoring

**Loan Types Supported:**
• Emergency loans (quick approval)
• Development loans (larger amounts)
• Educational loans (special rates)
• Business loans (extended terms)

**Available on:** Classic and Advanced plans

Need help setting up loan policies for your chama?`,
                followUp: ['loan policies', 'interest rates', 'repayment tracking']
            },

            'troubleshooting': {
                keywords: ['problem', 'issue', 'error', 'not working', 'help', 'trouble', 'bug', 'fix'],
                response: `🔧 **Troubleshooting Common Issues**

**Login Problems:**
• Clear your browser cache and cookies
• Try incognito/private browsing mode
• Check if your email is verified
• Reset password if needed
• Contact support if account is locked

**Payment Issues:**
• Verify M-Pesa transaction went through
• Check if amount matches expected contribution
• Ensure correct paybill/account number used
• Allow up to 5 minutes for processing
• Contact us if payment isn't reflected

**Member Invitation Problems:**
• Check if email address is correct
• Ask member to check spam/junk folder
• Try sending SMS invitation instead
• Resend invitation after 24 hours
• Manually add member if needed

**Report Generation Issues:**
• Ensure you have the required permissions
• Check if data range is valid
• Try generating smaller date ranges
• Clear browser cache and retry
• Use different browser if issues persist

**Performance Issues:**
• Check your internet connection
• Close unnecessary browser tabs
• Disable browser extensions
• Try a different browser or device
• Contact support if issues continue

Still having trouble? Describe your issue, and I'll assist you further!`,
                followUp: ['login issues', 'payment troubleshooting', 'member management']
            },

            'agent_help': {
                keywords: ['agent help', 'human help', 'speak with agent', 'contact support', 'live chat'],
                response: `🤝 **Connect with Our Support Team**

I've alerted our support team that you need assistance. An agent will respond to you shortly via:

• **Email**: Within 2 hours during business hours
• **Phone**: Call +254 700 000 000 for immediate help
• **WhatsApp**: Message us at +254 700 000 000

**What to expect:**
• A human agent will review our conversation
• They'll have context of what you've already discussed
• You'll get personalized assistance for your specific issue

**Business Hours:**
• Monday - Friday: 8:00 AM - 6:00 PM
• Saturday: 9:00 AM - 4:00 PM
• Sunday: Emergency support only

Is there anything specific you'd like me to let the agent know about?`,
                followUp: ['contact info', 'business hours', 'emergency support']
            }
        };
    }

    // Enhanced intent recognition
    analyzeIntent(message) {
        const lowerMessage = message.toLowerCase().trim();
        
        // Handle empty or very short messages
        if (lowerMessage.length === 0) {
            return { topic: 'general', confidence: 0.1, data: null };
        }
        
        // Enhanced pattern matching for better conversation
        let bestMatch = { topic: 'general', confidence: 0, data: null };
        
        for (const [topic, data] of Object.entries(this.knowledgeBase)) {
            let confidence = 0;
            
            // Exact keyword matches (highest confidence)
            for (const keyword of data.keywords) {
                if (lowerMessage === keyword.toLowerCase()) {
                    confidence = 1.0;
                    break;
                } else if (lowerMessage.includes(keyword.toLowerCase())) {
                    confidence = Math.max(confidence, 0.8);
                }
            }
            
            // Partial word matches for flexibility
            const messageWords = lowerMessage.split(' ');
            const keywordWords = data.keywords.flatMap(k => k.toLowerCase().split(' '));
            
            const matchedWords = messageWords.filter(word => 
                keywordWords.some(kwWord => kwWord.includes(word) || word.includes(kwWord))
            );
            
            if (matchedWords.length > 0) {
                const partialConfidence = (matchedWords.length / messageWords.length) * 0.6;
                confidence = Math.max(confidence, partialConfidence);
            }
            
            // Update best match if this is better
            if (confidence > bestMatch.confidence) {
                bestMatch = { topic, confidence, data };
            }
        }
        
        // Return best match if confidence is good enough
        if (bestMatch.confidence >= 0.3) {
            return bestMatch;
        }
        
        // Fallback for unmatched queries
        return { topic: 'general', confidence: 0.1, data: null };
    }

    // Generate response based on intent
    generateResponse(intent, userMessage) {
        if (intent.data) {
            this.context.lastTopic = intent.topic;
            this.context.conversationHistory.push({
                user: userMessage,
                bot: intent.data.response,
                topic: intent.topic,
                timestamp: new Date()
            });
            return intent.data.response;
        }

        // Fallback response with better understanding
        const responses = [
            `🤔 **I'm not quite sure about "${userMessage}"**, but I'm here to help!

Let me suggest some popular topics I can definitely assist you with:

🏦 **Chama Setup**: "How do I create a chama?" or "Getting started guide"
👥 **Member Management**: "How to add members?" or "Managing member roles"
💰 **Payments & M-Pesa**: "Setting up M-Pesa" or "Payment integration"
📊 **Reports**: "How to generate reports?" or "Financial analytics"
� **Troubleshooting**: "I need help with..." or "Problem with..."

**Just ask me naturally!** For example:
• "Can you help me set up my first chama?"
• "What payment methods do you support?"
• "How much does ChamaLink cost?"

*What would you like to know more about?*`,

            `💭 **I didn't quite catch that**, but I'm eager to help you succeed!

Here are some things I'm really good at explaining:

🚀 **Getting Started**: Complete setup guides and walkthroughs
� **Feature Explanations**: Detailed information about all ChamaLink features
💳 **Pricing & Plans**: Help you choose the right subscription
�️ **Technical Support**: Troubleshooting and problem-solving
📈 **Best Practices**: Tips for successful chama management

**Try rephrasing your question** or ask about:
• Chama creation and setup
• Member invitation and management
• Financial tracking and reporting
• Payment integration options

*I understand natural language, so just talk to me like you would a friend!*`
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }

    // Handle agent escalation
    async escalateToAgent(conversationHistory) {
        try {
            const response = await fetch('/api/agent-help', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversation_history: conversationHistory,
                    user_id: '{{ current_user.id if current_user.is_authenticated else "anonymous" }}',
                    timestamp: new Date().toISOString()
                })
            });

            if (response.ok) {
                return "🤝 **Agent Notified!**\n\nI've sent your conversation to our support team. You should hear back within 2 hours during business hours.\n\nFor immediate assistance:\n📞 **Call**: +254 700 000 000\n💬 **WhatsApp**: +254 700 000 000";
            } else {
                return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
            }
        } catch (error) {
            console.error('Error escalating to agent:', error);
            return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
        }
    }
}

// Initialize LeeBot
const leeBot = new LeeBot();
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

// Send message function
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');
    messageInput.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Check for agent help request
    if (message.toLowerCase().includes('agent help') || message.toLowerCase().includes('human help')) {
        const agentResponse = await leeBot.escalateToAgent(leeBot.context.conversationHistory);
        hideTypingIndicator();
        addMessage(agentResponse, 'bot');
        return;
    }

    // Process with LeeBot
    setTimeout(() => {
        const intent = leeBot.analyzeIntent(message);
        const response = leeBot.generateResponse(intent, message);
        
        hideTypingIndicator();
        addMessage(response, 'bot');
    }, 1000);
}

// Add message to chat
function addMessage(message, sender) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper mb-3';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message d-flex`;
    
    if (sender === 'user') {
        messageDiv.style.justifyContent = 'flex-end';
    }
    
    const messageContent = document.createElement('div');
    messageContent.className = `message-content ${sender === 'user' ? 'bg-primary text-white' : 'bg-white border'} rounded p-3 shadow-sm`;
    messageContent.style.maxWidth = '70%';
    
    if (sender === 'bot') {
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center';
        avatarDiv.style.width = '40px';
        avatarDiv.style.height = '40px';
        avatarDiv.style.flexShrink = '0';
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = `
            <strong>LeeBot</strong>
            <div class="text-muted small">Just now</div>
            <div class="mt-2">${message.replace(/\n/g, '<br>')}</div>
        `;
        
        messageContent.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(messageContent);
    } else {
        messageContent.innerHTML = message.replace(/\n/g, '<br>');
        messageDiv.appendChild(messageContent);
    }
    
    messageWrapper.appendChild(messageDiv);
    chatMessages.appendChild(messageWrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <strong>LeeBot</strong> is typing
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Quick topic handlers
document.querySelectorAll('.quick-topic').forEach(button => {
    button.addEventListener('click', function() {
        const topic = this.dataset.topic;
        
        // Get the response for this topic directly
        if (leeBot.knowledgeBase[topic]) {
            const response = leeBot.knowledgeBase[topic].response;
            addMessage(this.textContent.trim(), 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            // Add bot response after delay
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(response, 'bot');
            }, 1000);
        } else {
            // Fallback for unknown topics
            addMessage(this.textContent.trim(), 'user');
            sendMessage();
        }
    });
});

// Minimize chat functionality
document.getElementById('minimize-chat').addEventListener('click', function() {
    const chatContainer = document.getElementById('chat-container');
    const icon = this.querySelector('i');
    
    if (chatContainer.style.display === 'none') {
        chatContainer.style.display = 'block';
        icon.className = 'fas fa-minus';
    } else {
        chatContainer.style.display = 'none';
        icon.className = 'fas fa-plus';
    }
});

});
</script>
{% endblock %}
