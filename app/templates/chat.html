{% extends "base.html" %}

{% block title %}Help & Support - ChamaLink{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        LeeBot - ChamaLink Assistant
                    </h5>
                    <div class="d-flex align-items-center">
                        <span id="status-indicator" class="badge bg-success me-2">
                            <i class="fas fa-circle"></i> Online
                        </span>
                        <button id="minimize-chat" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="chat-container" class="card-body" style="height: 500px; overflow-y: auto; background: #f8f9fa;">
                    <div id="chat-messages">
                        <!-- Welcome message -->
                        <div class="message-wrapper mb-3">
                            <div class="message bot-message">
                                <div class="message-content bg-white border rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; flex-shrink: 0;">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div>
                                            <strong>LeeBot</strong>
                                            <div class="text-muted small">Just now</div>
                                            <div class="mt-2">
                                                üëã Hello! I'm LeeBot, your intelligent ChamaLink assistant.
                                                <br><br>
                                                I understand your questions and can help you with:
                                                <ul class="mb-2 mt-2">
                                                    <li>üè¶ Setting up and managing your chama</li>
                                                    <li>üí∞ Understanding our pricing and features</li>
                                                    <li>üì± Using M-Pesa and payment integration</li>
                                                    <li>üë• Managing members and contributions</li>
                                                    <li>üìä Generating reports and analytics</li>
                                                    <li>üîß Troubleshooting technical issues</li>
                                                </ul>
                                                Just ask me anything in natural language, and I'll provide detailed, helpful answers!
                                                <br><br>
                                                <strong>üí° Try asking:</strong> "How do I create a chama?" or "What's the difference between your plans?"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white border-top">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
                        <button id="send-button" class="btn btn-primary" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to send. Type "agent help" to speak with a human agent.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Quick Help Topics</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="chama_creation">
                            üè¶ Create Chama
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="subscription_plans">
                            üí∞ Compare Plans
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="mpesa_integration">
                            üì± M-Pesa Setup
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="member_management">
                            üë• Manage Members
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="reports_analytics">
                            üìä Reports & Analytics
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="agent_help">
                            ü§ù Speak with Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-wrapper {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white;
    border: none !important;
}

.bot-message .avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px;
    color: #666;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.quick-topic:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#chat-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
// LeeBot - Intelligent ChamaLink Assistant
class LeeBot {
    constructor() {
        this.context = {
            lastTopic: null,
            conversationHistory: [],
            userIntent: null
        };
        
        // Knowledge base for intelligent responses
        this.knowledgeBase = {
            // Chama Management
            'chama_creation': {
                keywords: ['create chama', 'start chama', 'new chama', 'setup chama', 'register chama', 'how to create'],
                response: `üè¶ **Creating a Chama on ChamaLink**

To create your chama:

**Step 1: Sign Up**
‚Ä¢ Visit ChamaLink.co.ke and click "Get Started"
‚Ä¢ Choose your subscription plan (we recommend starting with the free trial)
‚Ä¢ Complete your account registration

**Step 2: Set Up Your Chama**
‚Ä¢ Go to your dashboard and click "Create New Chama"
‚Ä¢ Enter your chama details:
  - Chama name
  - Meeting schedule
  - Contribution amounts and frequency
  - Rules and objectives

**Step 3: Add Members**
‚Ä¢ Invite members via email or phone
‚Ä¢ Set member roles (admin, treasurer, secretary, member)
‚Ä¢ Members will receive invitations to join

**Step 4: Configure Payments**
‚Ä¢ Set up your M-Pesa integration
‚Ä¢ Define contribution schedules
‚Ä¢ Enable automatic tracking

Would you like me to guide you through any specific step?`,
                followUp: ['member management', 'mpesa setup', 'subscription plans']
            },

            'member_management': {
                keywords: ['add members', 'invite members', 'member roles', 'remove member', 'manage members'],
                response: `üë• **Managing Chama Members**

**Adding Members:**
‚Ä¢ Navigate to "Members" in your chama dashboard
‚Ä¢ Click "Add Member" or "Invite Member"
‚Ä¢ Enter their details: name, email, phone number
‚Ä¢ Assign roles: Admin, Treasurer, Secretary, or Member
‚Ä¢ Send invitation (they'll get email/SMS)

**Member Roles & Permissions:**
‚Ä¢ **Admin**: Full access, can modify chama settings
‚Ä¢ **Treasurer**: Manages finances, approves transactions
‚Ä¢ **Secretary**: Records meetings, sends notifications
‚Ä¢ **Member**: Views information, makes contributions

**Managing Existing Members:**
‚Ä¢ Edit member details anytime
‚Ä¢ Change roles as needed
‚Ä¢ Suspend or remove inactive members
‚Ä¢ Track individual contribution history

**Pro Tip:** Start with 2-3 trusted friends, then gradually expand your chama!

Need help with specific member management tasks?`,
                followUp: ['roles and permissions', 'contribution tracking', 'member communication']
            },

            'subscription_plans': {
                keywords: ['plans', 'pricing', 'cost', 'subscription', 'how much', 'price', 'basic', 'classic', 'advanced'],
                response: `üí∞ **ChamaLink Subscription Plans**

**üéØ Basic Plan - KES 200/month**
‚Ä¢ Perfect for small chamas (up to 20 members)
‚Ä¢ Basic contribution tracking
‚Ä¢ M-Pesa integration
‚Ä¢ Monthly reports
‚Ä¢ Email support

**üöÄ Classic Plan - KES 250/month** ‚≠ê *Most Popular*
‚Ä¢ Enhanced features for growing chamas
‚Ä¢ Advanced reporting & analytics
‚Ä¢ Meeting management
‚Ä¢ Priority support
‚Ä¢ Data export features

**üíé Advanced Plan - KES 500/month**
‚Ä¢ Unlimited chamas and members
‚Ä¢ Premium analytics dashboard
‚Ä¢ Loan management system
‚Ä¢ API access for integrations
‚Ä¢ 24/7 priority support

**üéÅ Special Offers:**
‚Ä¢ 30-day FREE trial on all plans
‚Ä¢ 5% discount on 3-month subscriptions
‚Ä¢ Get 1 FREE month with 6-month plans
‚Ä¢ Get 2 FREE months with 12-month plans

Which plan interests you most?`,
                followUp: ['free trial', 'plan comparison', 'payment methods']
            },

            'mpesa_integration': {
                keywords: ['mpesa', 'm-pesa', 'payment', 'mobile money', 'safaricom', 'pay', 'paybill'],
                response: `üì± **M-Pesa Integration with ChamaLink**

**How it Works:**
‚Ä¢ Your chama gets a dedicated M-Pesa paybill or till number
‚Ä¢ Members send contributions directly via M-Pesa
‚Ä¢ Payments are automatically recorded in your system
‚Ä¢ Real-time notifications for all transactions
‚Ä¢ Zero manual data entry required!

**Setting Up M-Pesa:**
1. Go to "Payment Settings" in your chama dashboard
2. Choose "M-Pesa Integration"
3. Provide your business details
4. We'll help you get a paybill/till number
5. Configure automatic reconciliation

**Benefits:**
‚úÖ Instant payment confirmation
‚úÖ Automatic record keeping
‚úÖ Reduced errors and disputes
‚úÖ Member convenience
‚úÖ Real-time balance updates

**Requirements:**
‚Ä¢ Valid business registration (we can help with this)
‚Ä¢ Authorized signatory details
‚Ä¢ Bank account for settlements

Want me to guide you through the setup process?`,
                followUp: ['business registration', 'paybill setup', 'payment tracking']
            },

            'reports_analytics': {
                keywords: ['reports', 'analytics', 'statements', 'export', 'data', 'financial report', 'analysis'],
                response: `üìä **Reports & Analytics**

**Available Reports:**
‚Ä¢ **Member Contributions**: Individual payment history
‚Ä¢ **Financial Statements**: Income, expenses, balances
‚Ä¢ **Meeting Minutes**: Automated meeting records
‚Ä¢ **Loan Reports**: Outstanding loans and repayments
‚Ä¢ **Growth Analytics**: Membership and financial trends
‚Ä¢ **Tax Reports**: For compliance and documentation

**Export Options:**
‚Ä¢ PDF for sharing and printing
‚Ä¢ Excel for further analysis
‚Ä¢ CSV for data processing
‚Ä¢ Email delivery to stakeholders

**Real-Time Dashboards:**
‚Ä¢ Live contribution tracking
‚Ä¢ Member activity overview
‚Ä¢ Financial health indicators
‚Ä¢ Goal progress monitoring

**Automated Insights:**
‚Ä¢ Identify late payers
‚Ä¢ Track contribution trends
‚Ä¢ Forecast future growth
‚Ä¢ Risk assessment alerts

**Pro Feature (Classic & Advanced):**
‚Ä¢ Custom report builder
‚Ä¢ Scheduled report delivery
‚Ä¢ Advanced analytics with charts
‚Ä¢ Comparative analysis tools

Which type of report are you most interested in?`,
                followUp: ['financial statements', 'member reports', 'export options']
            },

            'loan_management': {
                keywords: ['loan', 'lending', 'borrow', 'credit', 'advance', 'loan application'],
                response: `üí≥ **Loan Management System**

**For Members (Borrowers):**
‚Ä¢ Apply for loans directly through the platform
‚Ä¢ View loan eligibility based on contributions
‚Ä¢ Track application status in real-time
‚Ä¢ Set up automatic repayment schedules
‚Ä¢ Access loan history and statements

**For Chama Administrators:**
‚Ä¢ Review and approve loan applications
‚Ä¢ Set loan policies and interest rates
‚Ä¢ Monitor repayment schedules
‚Ä¢ Generate loan portfolio reports
‚Ä¢ Manage defaulters and collections

**Loan Features:**
‚Ä¢ **Eligibility Calculator**: Based on contribution history
‚Ä¢ **Interest Management**: Flexible rate setting
‚Ä¢ **Repayment Tracking**: Automatic deductions
‚Ä¢ **Guarantor System**: Member-backed loans
‚Ä¢ **Risk Assessment**: Built-in credit scoring

**Loan Types Supported:**
‚Ä¢ Emergency loans (quick approval)
‚Ä¢ Development loans (larger amounts)
‚Ä¢ Educational loans (special rates)
‚Ä¢ Business loans (extended terms)

**Available on:** Classic and Advanced plans

Need help setting up loan policies for your chama?`,
                followUp: ['loan policies', 'interest rates', 'repayment tracking']
            },

            'troubleshooting': {
                keywords: ['problem', 'issue', 'error', 'not working', 'help', 'trouble', 'bug', 'fix'],
                response: `üîß **Troubleshooting Common Issues**

**Login Problems:**
‚Ä¢ Clear your browser cache and cookies
‚Ä¢ Try incognito/private browsing mode
‚Ä¢ Check if your email is verified
‚Ä¢ Reset password if needed
‚Ä¢ Contact support if account is locked

**Payment Issues:**
‚Ä¢ Verify M-Pesa transaction went through
‚Ä¢ Check if amount matches expected contribution
‚Ä¢ Ensure correct paybill/account number used
‚Ä¢ Allow up to 5 minutes for processing
‚Ä¢ Contact us if payment isn't reflected

**Member Invitation Problems:**
‚Ä¢ Check if email address is correct
‚Ä¢ Ask member to check spam/junk folder
‚Ä¢ Try sending SMS invitation instead
‚Ä¢ Resend invitation after 24 hours
‚Ä¢ Manually add member if needed

**Report Generation Issues:**
‚Ä¢ Ensure you have the required permissions
‚Ä¢ Check if data range is valid
‚Ä¢ Try generating smaller date ranges
‚Ä¢ Clear browser cache and retry
‚Ä¢ Use different browser if issues persist

**Performance Issues:**
‚Ä¢ Check your internet connection
‚Ä¢ Close unnecessary browser tabs
‚Ä¢ Disable browser extensions
‚Ä¢ Try a different browser or device
‚Ä¢ Contact support if issues continue

Still having trouble? Describe your issue, and I'll assist you further!`,
                followUp: ['login issues', 'payment troubleshooting', 'member management']
            },

            'agent_help': {
                keywords: ['agent help', 'human help', 'speak with agent', 'contact support', 'live chat'],
                response: `ü§ù **Connect with Our Support Team**

I've alerted our support team that you need assistance. An agent will respond to you shortly via:

‚Ä¢ **Email**: Within 2 hours during business hours
‚Ä¢ **Phone**: Call +254 700 000 000 for immediate help
‚Ä¢ **WhatsApp**: Message us at +254 700 000 000

**What to expect:**
‚Ä¢ A human agent will review our conversation
‚Ä¢ They'll have context of what you've already discussed
‚Ä¢ You'll get personalized assistance for your specific issue

**Business Hours:**
‚Ä¢ Monday - Friday: 8:00 AM - 6:00 PM
‚Ä¢ Saturday: 9:00 AM - 4:00 PM
‚Ä¢ Sunday: Emergency support only

Is there anything specific you'd like me to let the agent know about?`,
                followUp: ['contact info', 'business hours', 'emergency support']
            }
        };
    }

    // Enhanced intent recognition
    analyzeIntent(message) {
        const lowerMessage = message.toLowerCase();
        
        // Check for direct topic matches
        for (const [topic, data] of Object.entries(this.knowledgeBase)) {
            if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
                return { topic, confidence: 0.9, data };
            }
        }

        // Fallback for general queries
        return { topic: 'general', confidence: 0.3, data: null };
    }

    // Generate response based on intent
    generateResponse(intent, userMessage) {
        if (intent.data) {
            this.context.lastTopic = intent.topic;
            this.context.conversationHistory.push({
                user: userMessage,
                bot: intent.data.response,
                topic: intent.topic,
                timestamp: new Date()
            });
            return intent.data.response;
        }

        // Fallback response
        return `I understand you're asking about "${userMessage}". While I don't have specific information about that, I can help you with:

üè¶ Creating and managing chamas
üí∞ Understanding subscription plans
üì± M-Pesa integration and payments
üë• Member management
üìä Reports and analytics
üîß Troubleshooting issues

Could you rephrase your question or try one of the quick help topics below?`;
    }

    // Handle agent escalation
    async escalateToAgent(conversationHistory) {
        try {
            const response = await fetch('/api/agent-help', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversation_history: conversationHistory,
                    user_id: '{{ current_user.id if current_user.is_authenticated else "anonymous" }}',
                    timestamp: new Date().toISOString()
                })
            });

            if (response.ok) {
                return "ü§ù **Agent Notified!**\n\nI've sent your conversation to our support team. You should hear back within 2 hours during business hours.\n\nFor immediate assistance:\nüìû **Call**: +254 700 000 000\nüí¨ **WhatsApp**: +254 700 000 000";
            } else {
                return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
            }
        } catch (error) {
            console.error('Error escalating to agent:', error);
            return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
        }
    }
}

// Initialize LeeBot
const leeBot = new LeeBot();
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

// Send message function
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');
    messageInput.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Check for agent help request
    if (message.toLowerCase().includes('agent help') || message.toLowerCase().includes('human help')) {
        const agentResponse = await leeBot.escalateToAgent(leeBot.context.conversationHistory);
        hideTypingIndicator();
        addMessage(agentResponse, 'bot');
        return;
    }

    // Process with LeeBot
    setTimeout(() => {
        const intent = leeBot.analyzeIntent(message);
        const response = leeBot.generateResponse(intent, message);
        
        hideTypingIndicator();
        addMessage(response, 'bot');
    }, 1000);
}

// Add message to chat
function addMessage(message, sender) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper mb-3';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message d-flex`;
    
    if (sender === 'user') {
        messageDiv.style.justifyContent = 'flex-end';
    }
    
    const messageContent = document.createElement('div');
    messageContent.className = `message-content ${sender === 'user' ? 'bg-primary text-white' : 'bg-white border'} rounded p-3 shadow-sm`;
    messageContent.style.maxWidth = '70%';
    
    if (sender === 'bot') {
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center';
        avatarDiv.style.width = '40px';
        avatarDiv.style.height = '40px';
        avatarDiv.style.flexShrink = '0';
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = `
            <strong>LeeBot</strong>
            <div class="text-muted small">Just now</div>
            <div class="mt-2">${message.replace(/\n/g, '<br>')}</div>
        `;
        
        messageContent.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(messageContent);
    } else {
        messageContent.innerHTML = message.replace(/\n/g, '<br>');
        messageDiv.appendChild(messageContent);
    }
    
    messageWrapper.appendChild(messageDiv);
    chatMessages.appendChild(messageWrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <strong>LeeBot</strong> is typing
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Quick topic handlers
document.querySelectorAll('.quick-topic').forEach(button => {
    button.addEventListener('click', function() {
        const topic = this.dataset.topic;
        
        // Get the response for this topic directly
        if (leeBot.knowledgeBase[topic]) {
            const response = leeBot.knowledgeBase[topic].response;
            addMessage(this.textContent.trim(), 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            // Add bot response after delay
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(response, 'bot');
            }, 1000);
        } else {
            // Fallback for unknown topics
            addMessage(this.textContent.trim(), 'user');
            sendMessage();
        }
    });
});

// Minimize chat functionality
document.getElementById('minimize-chat').addEventListener('click', function() {
    const chatContainer = document.getElementById('chat-container');
    const icon = this.querySelector('i');
    
    if (chatContainer.style.display === 'none') {
        chatContainer.style.display = 'block';
        icon.className = 'fas fa-minus';
    } else {
        chatContainer.style.display = 'none';
        icon.className = 'fas fa-plus';
    }
});

});
</script>
{% endblock %}
