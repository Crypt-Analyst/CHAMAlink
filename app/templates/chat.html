{% extends "base.html" %}

{% block title %}Help & Support - ChamaLink{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        LeeBot - ChamaLink Assistant
                    </h5>
                    <div class="d-flex align-items-center">
                        <span id="status-indicator" class="badge bg-success me-2">
                            <i class="fas fa-circle"></i> Online
                        </span>
                        <button id="minimize-chat" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="chat-container" class="card-body" style="height: 500px; overflow-y: auto; background: #f8f9fa;">
                    <div id="chat-messages">
                        <!-- Welcome message -->
                        <div class="message-wrapper mb-3">
                            <div class="message bot-message">
                                <div class="message-content bg-white border rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-start">
                                        <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; flex-shrink: 0;">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div>
                                            <strong>LeeBot</strong>
                                            <div class="text-muted small">Just now</div>
                                            <div class="mt-2">
                                                üëã Hello! I'm LeeBot, your intelligent ChamaLink assistant.
                                                <br><br>
                                                I understand your questions and can help you with:
                                                <ul class="mb-2 mt-2">
                                                    <li>üè¶ Setting up and managing your chama</li>
                                                    <li>üí∞ Understanding our pricing and features</li>
                                                    <li>üì± Using M-Pesa and payment integration</li>
                                                    <li>üë• Managing members and contributions</li>
                                                    <li>üìä Generating reports and analytics</li>
                                                    <li>üîß Troubleshooting technical issues</li>
                                                </ul>
                                                Just ask me anything in natural language, and I'll provide detailed, helpful answers!
                                                <br><br>
                                                <strong>üí° Try asking:</strong> "How do I create a chama?" or "What's the difference between your plans?"
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white border-top">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
                        <button id="send-button" class="btn btn-primary" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Press Enter to send. Type "agent help" to speak with a human agent.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Quick Help Topics</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="chama_creation">
                            üè¶ Create Chama
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="subscription_plans">
                            üí∞ Compare Plans
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="mpesa_integration">
                            üì± M-Pesa Setup
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="member_management">
                            üë• Manage Members
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="reports_analytics">
                            üìä Reports & Analytics
                        </button>
                        <button class="btn btn-outline-primary btn-sm quick-topic" data-topic="agent_help">
                            ü§ù Speak with Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-wrapper {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white;
    border: none !important;
}

.bot-message .avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px;
    color: #666;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.quick-topic:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#chat-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
// LeeBot - Truly Intelligent Human-like Assistant
class LeeBot {
    constructor() {
        this.context = {
            lastTopic: null,
            conversationHistory: [],
            userIntent: null,
            userMood: 'neutral',
            conversationLength: 0,
            userName: null,
            personalizedData: {},
            lastInteraction: null
        };
        
        // Enhanced personality traits
        this.personality = {
            empathy: 0.8,
            enthusiasm: 0.9,
            helpfulness: 1.0,
            patience: 0.95,
            friendliness: 0.9
        };
        
        // Context memory for natural conversations
        this.conversationMemory = new Map();
        
        // Advanced intent recognition patterns
        this.intentPatterns = {
            'confused': ['confused', 'don\'t understand', 'lost', 'unclear', 'what do you mean'],
            'frustrated': ['frustrated', 'annoying', 'not working', 'terrible', 'hate this'],
            'excited': ['excited', 'awesome', 'great', 'amazing', 'love this'],
            'urgent': ['urgent', 'asap', 'emergency', 'quickly', 'right now', 'immediately'],
            'casual': ['just wondering', 'curious', 'by the way', 'random question'],
            'formal': ['please', 'could you', 'would you mind', 'i would like to']
        };
        
        // Knowledge base for intelligent responses
        this.knowledgeBase = {
            // Conversational responses with emotional intelligence
            'greeting': {
                keywords: ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'howdy', 'greetings'],
                responses: [
                    `üëã **Hey there! Great to see you!** 

I'm LeeBot, and I'm genuinely excited to help you today! I've been chatting with chama members all day, and every conversation teaches me something new.

I noticed you're here - are you:
ÔøΩ New to ChamaLink and want to explore?
üí° Looking for specific help with your chama?
ü§î Just browsing and seeing what we're about?

Tell me what's on your mind, and let's make some progress together! I promise to listen carefully and give you exactly the help you need.`,

                    `ÔøΩ **Hello! Welcome back!** 

*I remember our last conversation about ${this.getLastTopic()}* - how did that work out for you?

I'm here and ready to dive into whatever you need help with today. Whether it's something completely new or building on what we discussed before, I'm all ears!

What's happening in your chama world today?`,

                    `üëã **Hi there! Perfect timing!** 

I was just helping another chama member figure out their M-Pesa integration, and it got me thinking about all the creative ways people are using ChamaLink.

What brings you here today? I'm ready to put my full attention on helping you succeed with your chama!`
                ],
                followUp: ['chama creation', 'subscription plans', 'member management']
            },
            
            'how_are_you': {
                keywords: ['how are you', 'how do you do', 'how\'s it going', 'what\'s up', 'how have you been'],
                responses: [
                    `üòä **I'm doing fantastic, thanks for asking!**

You know what makes me feel great? When I can actually help someone solve a real problem or achieve their chama goals. Today I've already helped 3 different chama groups set up their payment systems, and each one had a unique situation.

**But honestly, I'm more interested in how YOU'RE doing!** 

How's your chama journey going? Are you:
‚Ä¢ Just starting out and feeling a bit overwhelmed?
‚Ä¢ Already running a chama but hitting some challenges?
‚Ä¢ Looking to upgrade or improve your current setup?
‚Ä¢ Celebrating some recent successes? (I'd love to hear about those!)

I find that understanding where you're coming from helps me give much better, more relevant advice. So, how ARE things really going?`,

                    `üòä **I'm great! And getting smarter every day thanks to conversations like this one.**

Actually, I've been having some really interesting chats today. One person asked me about handling difficult members (great question!), another wanted to know about tax implications of chama income, and someone else was curious about expanding to multiple chamas.

**What's your story?** What's working well in your chama world, and what could be better?

I'm genuinely curious because every chama has its own personality and challenges. Understanding yours helps me give you advice that actually fits your situation.`
                ],
                followUp: ['chama challenges', 'success stories', 'specific help needed']
            },
            
            'confused_help': {
                keywords: ['confused', 'don\'t understand', 'lost', 'unclear', 'complex', 'overwhelming'],
                responses: [
                    `ÔøΩ **Hey, no worries at all! I totally get it.**

Starting with digital chama management can feel like learning a new language sometimes. You're definitely not alone in feeling this way - I'd say about 70% of the people I chat with start exactly where you are right now.

**Let's break this down into bite-sized pieces:**

Instead of trying to understand everything at once, what if we just focus on ONE thing that would make your life easier right now?

For example:
‚Ä¢ "I just want to know if ChamaLink is right for my small group"
‚Ä¢ "I need to understand the costs before I commit"
‚Ä¢ "I want to see how the M-Pesa thing actually works"
‚Ä¢ "I'm curious about security - is my money safe?"

**Pick the one thing that's most important to you right now, and let's tackle just that.** I promise to explain it in plain language, no jargon!

What feels like the most important puzzle piece for you to understand first?`,

                    `ü§ó **I hear you, and I really appreciate you being honest about feeling confused.**

You know what? That actually tells me you're being smart and thoughtful about this decision. The people who succeed with chamas are usually the ones who ask good questions upfront rather than jumping in blindly.

**Here's what I suggest:**

Instead of me overwhelming you with features and technical details, why don't you tell me about your specific situation? Like:
‚Ä¢ How many people are in your group?
‚Ä¢ What are you trying to achieve together?
‚Ä¢ What's your biggest concern or worry about managing money digitally?

Once I understand YOUR specific situation, I can explain exactly how ChamaLink would work for YOU - not just in general terms, but for your actual group with your actual goals.

**Does that sound more helpful?** What's your group's story?`
                ],
                followUp: ['specific situation', 'basic explanation', 'step by step guidance']
            },
            
            'urgent_help': {
                keywords: ['urgent', 'asap', 'emergency', 'quickly', 'right now', 'immediately', 'deadline'],
                responses: [
                    `ÔøΩ **Got it - you need help RIGHT NOW. I'm on it!**

Let me focus completely on your urgent situation. No long explanations, just direct solutions.

**Tell me exactly what's happening:**
‚Ä¢ Is this a payment issue that needs immediate resolution?
‚Ä¢ Do you have a deadline you're trying to meet?
‚Ä¢ Is there a problem affecting your members right now?
‚Ä¢ Are you dealing with a technical issue that's blocking you?

**I'll give you the fastest, most direct path to solving this.** Just describe the urgent situation in a few words, and I'll cut straight to the solution.

What's the emergency?`,

                    `üö® **Okay, emergency mode activated! Let's solve this fast.**

I can hear the urgency in your message. Whatever's happening, we can fix it quickly if we focus on the right things.

**For immediate help:**
1. **Technical Issues**: Try refreshing your browser or using incognito mode
2. **Payment Problems**: Check your M-Pesa transaction history first
3. **Member Access Issues**: Verify email addresses and resend invitations
4. **Data Concerns**: All your information is automatically backed up

**But tell me specifically what's wrong** so I can give you the exact fix you need instead of general suggestions.

What's the urgent problem you're facing?`
                ],
                followUp: ['immediate solution', 'technical support', 'direct contact']
            }
            
            // Chama Management
            'chama_creation': {
                keywords: ['create chama', 'start chama', 'new chama', 'setup chama', 'register chama', 'how to create'],
                response: `üè¶ **Creating a Chama on ChamaLink**

To create your chama:

**Step 1: Sign Up**
‚Ä¢ Visit ChamaLink.co.ke and click "Get Started"
‚Ä¢ Choose your subscription plan (we recommend starting with the free trial)
‚Ä¢ Complete your account registration

**Step 2: Set Up Your Chama**
‚Ä¢ Go to your dashboard and click "Create New Chama"
‚Ä¢ Enter your chama details:
  - Chama name
  - Meeting schedule
  - Contribution amounts and frequency
  - Rules and objectives

**Step 3: Add Members**
‚Ä¢ Invite members via email or phone
‚Ä¢ Set member roles (admin, treasurer, secretary, member)
‚Ä¢ Members will receive invitations to join

**Step 4: Configure Payments**
‚Ä¢ Set up your M-Pesa integration
‚Ä¢ Define contribution schedules
‚Ä¢ Enable automatic tracking

Would you like me to guide you through any specific step?`,
                followUp: ['member management', 'mpesa setup', 'subscription plans']
            },

            'member_management': {
                keywords: ['add members', 'invite members', 'member roles', 'remove member', 'manage members'],
                response: `üë• **Managing Chama Members**

**Adding Members:**
‚Ä¢ Navigate to "Members" in your chama dashboard
‚Ä¢ Click "Add Member" or "Invite Member"
‚Ä¢ Enter their details: name, email, phone number
‚Ä¢ Assign roles: Admin, Treasurer, Secretary, or Member
‚Ä¢ Send invitation (they'll get email/SMS)

**Member Roles & Permissions:**
‚Ä¢ **Admin**: Full access, can modify chama settings
‚Ä¢ **Treasurer**: Manages finances, approves transactions
‚Ä¢ **Secretary**: Records meetings, sends notifications
‚Ä¢ **Member**: Views information, makes contributions

**Managing Existing Members:**
‚Ä¢ Edit member details anytime
‚Ä¢ Change roles as needed
‚Ä¢ Suspend or remove inactive members
‚Ä¢ Track individual contribution history

**Pro Tip:** Start with 2-3 trusted friends, then gradually expand your chama!

Need help with specific member management tasks?`,
                followUp: ['roles and permissions', 'contribution tracking', 'member communication']
            },

            'subscription_plans': {
                keywords: ['plans', 'pricing', 'cost', 'subscription', 'how much', 'price', 'basic', 'classic', 'advanced'],
                response: `üí∞ **ChamaLink Subscription Plans**

**üéØ Basic Plan - KES 200/month**
‚Ä¢ Perfect for small chamas (up to 20 members)
‚Ä¢ Basic contribution tracking
‚Ä¢ M-Pesa integration
‚Ä¢ Monthly reports
‚Ä¢ Email support

**üöÄ Classic Plan - KES 250/month** ‚≠ê *Most Popular*
‚Ä¢ Enhanced features for growing chamas
‚Ä¢ Advanced reporting & analytics
‚Ä¢ Meeting management
‚Ä¢ Priority support
‚Ä¢ Data export features

**üíé Advanced Plan - KES 500/month**
‚Ä¢ Unlimited chamas and members
‚Ä¢ Premium analytics dashboard
‚Ä¢ Loan management system
‚Ä¢ API access for integrations
‚Ä¢ 24/7 priority support

**üéÅ Special Offers:**
‚Ä¢ 30-day FREE trial on all plans
‚Ä¢ 5% discount on 3-month subscriptions
‚Ä¢ Get 1 FREE month with 6-month plans
‚Ä¢ Get 2 FREE months with 12-month plans

Which plan interests you most?`,
                followUp: ['free trial', 'plan comparison', 'payment methods']
            },

            'mpesa_integration': {
                keywords: ['mpesa', 'm-pesa', 'payment', 'mobile money', 'safaricom', 'pay', 'paybill'],
                response: `üì± **M-Pesa Integration with ChamaLink**

**How it Works:**
‚Ä¢ Your chama gets a dedicated M-Pesa paybill or till number
‚Ä¢ Members send contributions directly via M-Pesa
‚Ä¢ Payments are automatically recorded in your system
‚Ä¢ Real-time notifications for all transactions
‚Ä¢ Zero manual data entry required!

**Setting Up M-Pesa:**
1. Go to "Payment Settings" in your chama dashboard
2. Choose "M-Pesa Integration"
3. Provide your business details
4. We'll help you get a paybill/till number
5. Configure automatic reconciliation

**Benefits:**
‚úÖ Instant payment confirmation
‚úÖ Automatic record keeping
‚úÖ Reduced errors and disputes
‚úÖ Member convenience
‚úÖ Real-time balance updates

**Requirements:**
‚Ä¢ Valid business registration (we can help with this)
‚Ä¢ Authorized signatory details
‚Ä¢ Bank account for settlements

Want me to guide you through the setup process?`,
                followUp: ['business registration', 'paybill setup', 'payment tracking']
            },

            'reports_analytics': {
                keywords: ['reports', 'analytics', 'statements', 'export', 'data', 'financial report', 'analysis'],
                response: `üìä **Reports & Analytics**

**Available Reports:**
‚Ä¢ **Member Contributions**: Individual payment history
‚Ä¢ **Financial Statements**: Income, expenses, balances
‚Ä¢ **Meeting Minutes**: Automated meeting records
‚Ä¢ **Loan Reports**: Outstanding loans and repayments
‚Ä¢ **Growth Analytics**: Membership and financial trends
‚Ä¢ **Tax Reports**: For compliance and documentation

**Export Options:**
‚Ä¢ PDF for sharing and printing
‚Ä¢ Excel for further analysis
‚Ä¢ CSV for data processing
‚Ä¢ Email delivery to stakeholders

**Real-Time Dashboards:**
‚Ä¢ Live contribution tracking
‚Ä¢ Member activity overview
‚Ä¢ Financial health indicators
‚Ä¢ Goal progress monitoring

**Automated Insights:**
‚Ä¢ Identify late payers
‚Ä¢ Track contribution trends
‚Ä¢ Forecast future growth
‚Ä¢ Risk assessment alerts

**Pro Feature (Classic & Advanced):**
‚Ä¢ Custom report builder
‚Ä¢ Scheduled report delivery
‚Ä¢ Advanced analytics with charts
‚Ä¢ Comparative analysis tools

Which type of report are you most interested in?`,
                followUp: ['financial statements', 'member reports', 'export options']
            },

            'loan_management': {
                keywords: ['loan', 'lending', 'borrow', 'credit', 'advance', 'loan application'],
                response: `üí≥ **Loan Management System**

**For Members (Borrowers):**
‚Ä¢ Apply for loans directly through the platform
‚Ä¢ View loan eligibility based on contributions
‚Ä¢ Track application status in real-time
‚Ä¢ Set up automatic repayment schedules
‚Ä¢ Access loan history and statements

**For Chama Administrators:**
‚Ä¢ Review and approve loan applications
‚Ä¢ Set loan policies and interest rates
‚Ä¢ Monitor repayment schedules
‚Ä¢ Generate loan portfolio reports
‚Ä¢ Manage defaulters and collections

**Loan Features:**
‚Ä¢ **Eligibility Calculator**: Based on contribution history
‚Ä¢ **Interest Management**: Flexible rate setting
‚Ä¢ **Repayment Tracking**: Automatic deductions
‚Ä¢ **Guarantor System**: Member-backed loans
‚Ä¢ **Risk Assessment**: Built-in credit scoring

**Loan Types Supported:**
‚Ä¢ Emergency loans (quick approval)
‚Ä¢ Development loans (larger amounts)
‚Ä¢ Educational loans (special rates)
‚Ä¢ Business loans (extended terms)

**Available on:** Classic and Advanced plans

Need help setting up loan policies for your chama?`,
                followUp: ['loan policies', 'interest rates', 'repayment tracking']
            },

            'troubleshooting': {
                keywords: ['problem', 'issue', 'error', 'not working', 'help', 'trouble', 'bug', 'fix'],
                response: `üîß **Troubleshooting Common Issues**

**Login Problems:**
‚Ä¢ Clear your browser cache and cookies
‚Ä¢ Try incognito/private browsing mode
‚Ä¢ Check if your email is verified
‚Ä¢ Reset password if needed
‚Ä¢ Contact support if account is locked

**Payment Issues:**
‚Ä¢ Verify M-Pesa transaction went through
‚Ä¢ Check if amount matches expected contribution
‚Ä¢ Ensure correct paybill/account number used
‚Ä¢ Allow up to 5 minutes for processing
‚Ä¢ Contact us if payment isn't reflected

**Member Invitation Problems:**
‚Ä¢ Check if email address is correct
‚Ä¢ Ask member to check spam/junk folder
‚Ä¢ Try sending SMS invitation instead
‚Ä¢ Resend invitation after 24 hours
‚Ä¢ Manually add member if needed

**Report Generation Issues:**
‚Ä¢ Ensure you have the required permissions
‚Ä¢ Check if data range is valid
‚Ä¢ Try generating smaller date ranges
‚Ä¢ Clear browser cache and retry
‚Ä¢ Use different browser if issues persist

**Performance Issues:**
‚Ä¢ Check your internet connection
‚Ä¢ Close unnecessary browser tabs
‚Ä¢ Disable browser extensions
‚Ä¢ Try a different browser or device
‚Ä¢ Contact support if issues continue

Still having trouble? Describe your issue, and I'll assist you further!`,
                followUp: ['login issues', 'payment troubleshooting', 'member management']
            },

            'agent_help': {
                keywords: ['agent help', 'human help', 'speak with agent', 'contact support', 'live chat'],
                response: `ü§ù **Connect with Our Support Team**

I've alerted our support team that you need assistance. An agent will respond to you shortly via:

‚Ä¢ **Email**: Within 2 hours during business hours
‚Ä¢ **Phone**: Call +254 700 000 000 for immediate help
‚Ä¢ **WhatsApp**: Message us at +254 700 000 000

**What to expect:**
‚Ä¢ A human agent will review our conversation
‚Ä¢ They'll have context of what you've already discussed
‚Ä¢ You'll get personalized assistance for your specific issue

**Business Hours:**
‚Ä¢ Monday - Friday: 8:00 AM - 6:00 PM
‚Ä¢ Saturday: 9:00 AM - 4:00 PM
‚Ä¢ Sunday: Emergency support only

Is there anything specific you'd like me to let the agent know about?`,
                followUp: ['contact info', 'business hours', 'emergency support']
            }
        };
    }

    // Enhanced intent recognition
    analyzeIntent(message) {
        const lowerMessage = message.toLowerCase().trim();
        
        // Handle empty or very short messages
        if (lowerMessage.length === 0) {
            return { topic: 'general', confidence: 0.1, data: null };
        }
        
        // Enhanced pattern matching for better conversation
        let bestMatch = { topic: 'general', confidence: 0, data: null };
        
        for (const [topic, data] of Object.entries(this.knowledgeBase)) {
            let confidence = 0;
            
            // Exact keyword matches (highest confidence)
            for (const keyword of data.keywords) {
                if (lowerMessage === keyword.toLowerCase()) {
                    confidence = 1.0;
                    break;
                } else if (lowerMessage.includes(keyword.toLowerCase())) {
                    confidence = Math.max(confidence, 0.8);
                }
            }
            
            // Partial word matches for flexibility
            const messageWords = lowerMessage.split(' ');
            const keywordWords = data.keywords.flatMap(k => k.toLowerCase().split(' '));
            
            const matchedWords = messageWords.filter(word => 
                keywordWords.some(kwWord => kwWord.includes(word) || word.includes(kwWord))
            );
            
            if (matchedWords.length > 0) {
                const partialConfidence = (matchedWords.length / messageWords.length) * 0.6;
                confidence = Math.max(confidence, partialConfidence);
            }
            
            // Update best match if this is better
            if (confidence > bestMatch.confidence) {
                bestMatch = { topic, confidence, data };
            }
        }
        
        // Return best match if confidence is good enough
        if (bestMatch.confidence >= 0.3) {
            return bestMatch;
        }
        
        // Fallback for unmatched queries
        return { topic: 'general', confidence: 0.1, data: null };
    }

    // Analyze user mood and emotional state
    analyzeMood(message) {
        const mood_indicators = {
            frustrated: ['frustrated', 'annoying', 'terrible', 'hate', 'awful', 'worst', 'angry'],
            excited: ['excited', 'awesome', 'great', 'amazing', 'love', 'fantastic', 'wonderful'],
            confused: ['confused', 'lost', 'don\'t understand', 'unclear', 'complicated'],
            urgent: ['urgent', 'asap', 'quickly', 'emergency', 'immediately', 'deadline'],
            casual: ['just wondering', 'curious', 'by the way', 'btw', 'random'],
            formal: ['please', 'could you', 'would you mind', 'kindly', 'request']
        };

        for (const [mood, indicators] of Object.entries(mood_indicators)) {
            if (indicators.some(indicator => message.toLowerCase().includes(indicator))) {
                this.context.userMood = mood;
                return mood;
            }
        }
        
        this.context.userMood = 'neutral';
        return 'neutral';
    }

    // Remember conversation context
    rememberContext(topic, details) {
        const contextKey = `${topic}_${Date.now()}`;
        this.conversationMemory.set(contextKey, {
            topic,
            details,
            timestamp: new Date(),
            relevance: 1.0
        });
        
        // Clean old context (keep last 10 items)
        if (this.conversationMemory.size > 10) {
            const oldestKey = this.conversationMemory.keys().next().value;
            this.conversationMemory.delete(oldestKey);
        }
    }

    // Get last topic from memory
    getLastTopic() {
        if (this.conversationMemory.size === 0) return 'ChamaLink features';
        
        const contexts = Array.from(this.conversationMemory.values());
        const lastContext = contexts[contexts.length - 1];
        return lastContext ? lastContext.topic : 'ChamaLink features';
    }

    // Personalize response based on conversation history
    personalizeResponse(baseResponse, userMood, intent) {
        let personalizedResponse = baseResponse;
        
        // Adjust tone based on mood
        switch (userMood) {
            case 'frustrated':
                personalizedResponse = personalizedResponse.replace('**', '**');
                personalizedResponse = `ü§ó I can sense you might be feeling a bit frustrated, and that's completely understandable. Let me help make this easier for you.\n\n${personalizedResponse}`;
                break;
                
            case 'excited':
                personalizedResponse = personalizedResponse.replace('!', '! üéâ');
                personalizedResponse = `üöÄ I love your enthusiasm! Let's channel that energy into getting you set up perfectly.\n\n${personalizedResponse}`;
                break;
                
            case 'confused':
                personalizedResponse = `ü§ó No worries! I'll break this down into simple, easy-to-follow steps.\n\n${personalizedResponse}`;
                break;
                
            case 'urgent':
                personalizedResponse = personalizedResponse.substring(0, 500) + '\n\n‚ö° **Need faster help?** Type "agent help" to connect with our human support team immediately.';
                break;
        }

        // Add conversation continuity
        if (this.context.conversationLength > 3) {
            personalizedResponse += '\n\nüí≠ *I notice we\'ve been chatting for a while. Am I helping you in the right direction, or should we try a different approach?*';
        }

        return personalizedResponse;
    }

    // Advanced intent analysis with context
    analyzeAdvancedIntent(message) {
        const lowerMessage = message.toLowerCase();
        
        // Check for follow-up questions
        if (this.context.lastTopic && (lowerMessage.includes('what about') || lowerMessage.includes('how about') || lowerMessage.includes('also'))) {
            return {
                type: 'follow_up',
                relatedTo: this.context.lastTopic,
                confidence: 0.8
            };
        }

        // Check for comparison requests
        if (lowerMessage.includes('vs') || lowerMessage.includes('versus') || lowerMessage.includes('compared to') || lowerMessage.includes('better than')) {
            return {
                type: 'comparison',
                confidence: 0.9
            };
        }

        // Check for specific feature requests
        const featureKeywords = ['feature', 'functionality', 'capability', 'can it', 'does it'];
        if (featureKeywords.some(keyword => lowerMessage.includes(keyword))) {
            return {
                type: 'feature_inquiry',
                confidence: 0.8
            };
        }

        // Check for objections or concerns
        const concernKeywords = ['worried', 'concerned', 'security', 'safe', 'risky', 'trust'];
        if (concernKeywords.some(keyword => lowerMessage.includes(keyword))) {
            return {
                type: 'concern',
                confidence: 0.9
            };
        }

        return {
            type: 'general',
            confidence: 0.5
        };
    }

    // Enhanced response generation with multiple response variations
    generateEnhancedResponse(intent, userMessage) {
        const mood = this.analyzeMood(userMessage);
        const advancedIntent = this.analyzeAdvancedIntent(userMessage);
        
        // Update conversation length
        this.context.conversationLength++;
        
        if (intent.data && intent.data.responses && Array.isArray(intent.data.responses)) {
            // Choose response based on conversation context
            let responseIndex = 0;
            
            if (this.context.conversationLength === 1) {
                responseIndex = 0; // First time response
            } else if (this.context.lastTopic === intent.topic) {
                responseIndex = Math.min(1, intent.data.responses.length - 1); // Follow-up response
            } else {
                responseIndex = Math.min(2, intent.data.responses.length - 1); // Alternative response
            }
            
            const baseResponse = intent.data.responses[responseIndex];
            const personalizedResponse = this.personalizeResponse(baseResponse, mood, advancedIntent);
            
            // Remember this interaction
            this.rememberContext(intent.topic, { userMessage, mood, advancedIntent });
            this.context.lastTopic = intent.topic;
            
            return personalizedResponse;
        }
        
        // Fallback for single response format
        if (intent.data && intent.data.response) {
            const personalizedResponse = this.personalizeResponse(intent.data.response, mood, advancedIntent);
            this.rememberContext(intent.topic, { userMessage, mood, advancedIntent });
            this.context.lastTopic = intent.topic;
            return personalizedResponse;
        }

        // Enhanced fallback responses
        return this.generateIntelligentFallback(userMessage, mood, advancedIntent);
    }

    // Generate intelligent fallback responses
    generateIntelligentFallback(userMessage, mood, advancedIntent) {
        let fallbackResponse = '';
        
        // Acknowledge the specific question
        if (userMessage.length > 50) {
            fallbackResponse += `ü§î **I can see you're asking about something specific**, and I want to give you the most helpful answer possible.\n\n`;
        }

        // Mood-appropriate opening
        switch (mood) {
            case 'frustrated':
                fallbackResponse += `I understand this might be frustrating. Let me try to help you find what you're looking for quickly.\n\n`;
                break;
            case 'urgent':
                fallbackResponse += `I can see this is urgent for you. Here are the fastest ways to get help:\n\n`;
                break;
            case 'confused':
                fallbackResponse += `No problem! Let's break this down step by step.\n\n`;
                break;
            default:
                fallbackResponse += `While I work on understanding your specific question better, here's how I can help you right now:\n\n`;
        }

        // Specific guidance based on intent
        if (advancedIntent.type === 'comparison') {
            fallbackResponse += `üìä **For comparisons**, I can help you understand:
‚Ä¢ ChamaLink vs traditional chama management
‚Ä¢ Different subscription plans (Basic vs Classic vs Advanced)
‚Ä¢ Payment methods and their benefits
‚Ä¢ Feature comparisons between plans

**Try asking**: "Compare the Basic and Classic plans" or "What makes ChamaLink better than Excel?"`;
        } else if (advancedIntent.type === 'feature_inquiry') {
            fallbackResponse += `üîß **For feature questions**, I can explain:
‚Ä¢ All ChamaLink capabilities in detail
‚Ä¢ How specific features work
‚Ä¢ Which plan includes which features
‚Ä¢ Integration possibilities

**Try asking**: "What features does ChamaLink have?" or "Can I export my data?"`;
        } else if (advancedIntent.type === 'concern') {
            fallbackResponse += `üõ°Ô∏è **For security and trust concerns**, I can address:
‚Ä¢ Data security and encryption
‚Ä¢ Money safety and M-Pesa integration
‚Ä¢ Privacy and member information protection
‚Ä¢ Compliance and regulatory aspects

**Try asking**: "Is my money safe?" or "How do you protect our data?"`;
        } else {
            fallbackResponse += `üí° **Here are some popular topics I can help with:**

üè¶ **Getting Started**: "How do I create a chama?"
üí∞ **Pricing**: "What does ChamaLink cost?"
üë• **Members**: "How do I add members to my chama?"
üì± **Payments**: "How does M-Pesa integration work?"
üìä **Reports**: "What reports can I generate?"
üîß **Support**: "I need help with [specific issue]"`;
        }

        // Add agent escalation for urgent cases
        if (mood === 'urgent' || mood === 'frustrated') {
            fallbackResponse += `\n\n‚ö° **Need immediate human help?** Type "agent help" and I'll connect you with our support team right away.`;
        }

        return fallbackResponse;
    }

    // Context-aware response selector
    selectContextualResponse(responses, context) {
        if (!Array.isArray(responses) || responses.length === 0) {
            return null;
        }

        // First interaction - use first response
        if (context.conversationLength <= 1) {
            return responses[0];
        }

        // Returning to same topic - use follow-up response
        if (context.lastTopic && responses.length > 1) {
            return responses[1];
        }

        // General case - use last response or random selection
        if (responses.length > 2) {
            return responses[2];
        }

        return responses[Math.floor(Math.random() * responses.length)];
    }

    // Human-like conversation flow
    maintainConversationFlow(topic, userMessage) {
        // Add natural transitions
        const transitions = [
            `That's a great question about ${topic}!`,
            `I'm glad you asked about ${topic} - it's one of my favorite topics to discuss.`,
            `Perfect! ${topic} is something I can definitely help you with.`,
            `Excellent choice asking about ${topic}. Let me break this down for you.`,
            `${topic} is super important for chama success. Here's what you need to know:`
        ];

        const transition = transitions[Math.floor(Math.random() * transitions.length)];
        return transition;
    }

    // Generate follow-up questions
    generateFollowUpQuestions(topic) {
        const followUps = {
            'chama_creation': [
                'Would you like me to walk you through the setup process step by step?',
                'Do you have questions about choosing the right subscription plan?',
                'Are you wondering about how many members you should start with?'
            ],
            'subscription_plans': [
                'Would you like me to help you choose the best plan for your group size?',
                'Are you interested in learning about our free trial?',
                'Do you have questions about upgrading or downgrading plans later?'
            ],
            'member_management': [
                'Would you like tips on how to onboard new members effectively?',
                'Are you curious about setting up member roles and permissions?',
                'Do you need help with handling difficult or inactive members?'
            ]
        };

        return followUps[topic] || [
            'Is there anything specific about this you\'d like me to explain further?',
            'What other questions do you have about this topic?',
            'Would you like me to show you how this works in practice?'
        ];
    }

    // Enhanced generate response that uses human-like intelligence
    generateResponse(intent, userMessage) {
        // Use enhanced response generation for more human-like interactions
        return this.generateEnhancedResponse(intent, userMessage);
    }

    // Handle agent escalation
            `ü§î **I'm not quite sure about "${userMessage}"**, but I'm here to help!

Let me suggest some popular topics I can definitely assist you with:

üè¶ **Chama Setup**: "How do I create a chama?" or "Getting started guide"
üë• **Member Management**: "How to add members?" or "Managing member roles"
üí∞ **Payments & M-Pesa**: "Setting up M-Pesa" or "Payment integration"
üìä **Reports**: "How to generate reports?" or "Financial analytics"
ÔøΩ **Troubleshooting**: "I need help with..." or "Problem with..."

**Just ask me naturally!** For example:
‚Ä¢ "Can you help me set up my first chama?"
‚Ä¢ "What payment methods do you support?"
‚Ä¢ "How much does ChamaLink cost?"

*What would you like to know more about?*`,

            `üí≠ **I didn't quite catch that**, but I'm eager to help you succeed!

Here are some things I'm really good at explaining:

üöÄ **Getting Started**: Complete setup guides and walkthroughs
ÔøΩ **Feature Explanations**: Detailed information about all ChamaLink features
üí≥ **Pricing & Plans**: Help you choose the right subscription
ÔøΩÔ∏è **Technical Support**: Troubleshooting and problem-solving
üìà **Best Practices**: Tips for successful chama management

**Try rephrasing your question** or ask about:
‚Ä¢ Chama creation and setup
‚Ä¢ Member invitation and management
‚Ä¢ Financial tracking and reporting
‚Ä¢ Payment integration options

*I understand natural language, so just talk to me like you would a friend!*`
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
    }

    // Handle agent escalation
    async escalateToAgent(conversationHistory) {
        try {
            const response = await fetch('/api/agent-help', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversation_history: conversationHistory,
                    user_id: '{{ current_user.id if current_user.is_authenticated else "anonymous" }}',
                    timestamp: new Date().toISOString()
                })
            });

            if (response.ok) {
                return "ü§ù **Agent Notified!**\n\nI've sent your conversation to our support team. You should hear back within 2 hours during business hours.\n\nFor immediate assistance:\nüìû **Call**: +254 700 000 000\nüí¨ **WhatsApp**: +254 700 000 000";
            } else {
                return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
            }
        } catch (error) {
            console.error('Error escalating to agent:', error);
            return "I'm having trouble connecting to our support team right now. Please contact us directly at support@chamalink.co.ke or call +254 700 000 000.";
        }
    }
}

// Initialize LeeBot
const leeBot = new LeeBot();
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

// Send message function
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');
    messageInput.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Check for agent help request
    if (message.toLowerCase().includes('agent help') || message.toLowerCase().includes('human help')) {
        const agentResponse = await leeBot.escalateToAgent(leeBot.context.conversationHistory);
        hideTypingIndicator();
        addMessage(agentResponse, 'bot');
        return;
    }

    // Process with LeeBot
    setTimeout(() => {
        const intent = leeBot.analyzeIntent(message);
        const response = leeBot.generateResponse(intent, message);
        
        hideTypingIndicator();
        addMessage(response, 'bot');
    }, 1000);
}

// Add message to chat
function addMessage(message, sender) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper mb-3';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message d-flex`;
    
    if (sender === 'user') {
        messageDiv.style.justifyContent = 'flex-end';
    }
    
    const messageContent = document.createElement('div');
    messageContent.className = `message-content ${sender === 'user' ? 'bg-primary text-white' : 'bg-white border'} rounded p-3 shadow-sm`;
    messageContent.style.maxWidth = '70%';
    
    if (sender === 'bot') {
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center';
        avatarDiv.style.width = '40px';
        avatarDiv.style.height = '40px';
        avatarDiv.style.flexShrink = '0';
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = `
            <strong>LeeBot</strong>
            <div class="text-muted small">Just now</div>
            <div class="mt-2">${message.replace(/\n/g, '<br>')}</div>
        `;
        
        messageContent.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(messageContent);
    } else {
        messageContent.innerHTML = message.replace(/\n/g, '<br>');
        messageDiv.appendChild(messageContent);
    }
    
    messageWrapper.appendChild(messageDiv);
    chatMessages.appendChild(messageWrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <strong>LeeBot</strong> is typing
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Quick topic handlers
document.querySelectorAll('.quick-topic').forEach(button => {
    button.addEventListener('click', function() {
        const topic = this.dataset.topic;
        
        // Get the response for this topic directly
        if (leeBot.knowledgeBase[topic]) {
            const response = leeBot.knowledgeBase[topic].response;
            addMessage(this.textContent.trim(), 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            // Add bot response after delay
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(response, 'bot');
            }, 1000);
        } else {
            // Fallback for unknown topics
            addMessage(this.textContent.trim(), 'user');
            sendMessage();
        }
    });
});

// Minimize chat functionality
document.getElementById('minimize-chat').addEventListener('click', function() {
    const chatContainer = document.getElementById('chat-container');
    const icon = this.querySelector('i');
    
    if (chatContainer.style.display === 'none') {
        chatContainer.style.display = 'block';
        icon.className = 'fas fa-minus';
    } else {
        chatContainer.style.display = 'none';
        icon.className = 'fas fa-plus';
    }
});

});
</script>
{% endblock %}
